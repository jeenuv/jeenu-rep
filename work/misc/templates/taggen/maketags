#!/bin/bash

function script_echo()
{
    echo "$PROGNAME: $@"
}

function buildfiles()
{

    if [ -f "$2" ]; then
        read -p "$PROGNAME: delete and remake $2 (y/n)? "
        if [ "$REPLY" = "y" -o "$REPLY" = "Y" ]; then
            rm "$2"
            script_echo "building list of files"
            find $1 -name .svn -prune -o $(echo $FIND_EXPR) -print > "$2"
        fi
    else
        script_echo "building list of files"
        find $1 -name .svn -prune -o $(echo $FIND_EXPR) -print > "$2"
    fi
}

PROGNAME=$(basename $0)
THISDIR=$( (cd $(dirname $0) && pwd) )
TAGLIST=files.ctags.list
CSCOPELIST=files.cscope.list

cd "$THISDIR"

[ -f initrc ] && source initrc

if [ -z "$PROJECT_ROOT" ]; then
    script_echo "\$PROJECT_ROOT is not set!"
else
    script_echo "using \$PROJECT_ROOT as $PROJECT_ROOT"
fi

FIND_EXPR="( -iname *.cpp -o -iname *.h -o -iname *.inl -o -iname *.s -o -iname *.cia -o -iname *.inc )"
TAGDIRS="$PROJECT_ROOT/e32
         $PROJECT_ROOT/f32
         $PROJECT_ROOT/bsp/hwip_arm"
CSCOPEDIRS="$PROJECT_ROOT/e32
            $PROJECT_ROOT/f32
            $PROJECT_ROOT/bsp/hwip_arm"

if [ ! -d "$PROJECT_ROOT" ]; then
    script_echo "directory $PROJECT_ROOT doesn't exist!"
    exit 1
fi

if confirm "build tags"; then
    buildfiles "$TAGDIRS" "$TAGLIST"

    # Delete the tag file if already existing
    [ -f "$TAGFILENAME" ] && rm $TAGFILENAME

    script_echo "building tags"
    if ctags -L $TAGLIST \
            --langmap=c++:+.inl,c++:+.cia,asm:+.inc \
            --extra=+f \
            --extra=+q \
            -I __FALCON__ \
            -I NONSHARABLE_CLASS=class\
            -I EXPORT_C \
            -I IMPORT_C; then
        script_echo "tags built"
    else
        script_echo "error building tags"
    fi
fi

## CSCOPE setup

if confirm "build cscope"; then
    buildfiles "$CSCOPEDIRS" "$CSCOPELIST"

    if mlcscope -b -q -k -i "$CSCOPELIST" -f cscope; then
        script_echo "cscope db built"
    else
        script_echo "error building cs db"
    fi
fi
