#!/bin/bash

# Scriptlet for filtering stgit refs
script_file="$HOME/tmp/filter-stgit-branches"
[ ! -x "$script_file" ] && cat <<-EOF >"$script_file"  && chmod +x "$script_file"
#!/bin/bash
# Generated by $HOME/.mygitutils
git show-ref --heads | awk -F/ '!/\.stgit/{print \$NF}'
EOF

# Scriptlet for sb git command alias
script_file="$HOME/tmp/git-sb"
[ ! -x "$script_file" ] && cat <<-EOF >"$script_file"  && chmod +x "$script_file"
#!/bin/bash
# Generated by $HOME/.mygitutils
script="$HOME/tmp/filter-stgit-branches"
if [ -x "\$script" ]; then
    git show-branch --color "\$@" \$(\$script) |
    less -iRSw
else
    git show-branch "\$@";
fi
EOF

unset script_file

# To list all git modified items in the given directory
function gitmodified()
{
    git rev-parse || return 1
    git diff --diff-filter=M --name-only "$@"
}

# Recursively show diffs for all the modified files
function gitshowdiffs()
{
    (
    git_patch_file="$HOME/tmp/gitpatchfile"
    wd_now="$PWD"

    git_dir="$(git rev-parse --git-dir)" || return 1
    cd "$git_dir/.."
    for i in $(gitmodified "$@"); do
        # prompt for continue
        if ! confirm "$i: continue" 1; then
            if [ "$CONFIRMED" = "no" ]; then
                echo
                continue
            elif [ "$CONFIRMED" = "quit" ]; then
                echo
                return
            fi
        fi

        # With control character to clear the entire line
        echo -e "\r\e[2Kgetting diff..."
        git diff --no-prefix --no-ext-diff "$i" > "$git_patch_file" || return

        if [ "$(stat -c %s "$git_patch_file")" -eq 0 ]; then
            echo "gitshowdiffs: $i: no diff found"
            continue
        else
            DISPLAY= vim -n '+set patchexpr=MyPatch()' \
                   "+leftabove vertical diffpatch $git_patch_file |cmap q qa|nmap <F7> ]c|nmap <F6> [c|windo set fdm=diff nolist|normal gg" \
            "$i"
        fi
    done
    )
}

# Open gitk window without stgit-managed branches
function gitk()
{
    if [ -n "$*" ]; then
        command gitk "$@"
        return
    fi

    local script_file="$HOME/tmp/filter-stgit-branches"
    if  [ ! -x "$script_file" ]; then
        echo "$script_file not found"
        return 1
    fi
    # Dummy rev-parse invocation to make sure we're in a git repository
    git rev-parse && command gitk --argscmd="$script_file" &>/dev/null
}
